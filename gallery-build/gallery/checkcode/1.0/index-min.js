KISSY.add("gallery/checkcode/1.0/index",function(b){var g=b.DOM,l=1,m=/^[\da-zA-Z]{4}$/,n=-1!==navigator.userAgent.indexOf("Windows"),o=b.UA.ie,j=b.UA.firefox,k=b.now(),h=b.now(),f={},i=function(a){if(!(this instanceof i))return new i(a);this.input=a.input&&b.one(a.input);this.container=a.container&&b.one(a.container);this.prefixCls=b.isString(a.prefixCls)?a.prefixCls:"";this.identity=b.isString(a.identity)?a.identity:"";this.sessionid=b.isString(a.sessionid)?a.sessionid:"";this.apiserver=b.isString(a.apiserver)&&
a.apiserver?a.apiserver:"http://pin.aliyun.com";this.checkedCode="";this.uid=l++};b.augment(i,b.EventTarget,{init:function(){if(this.container&&this.input&&this.identity&&this.sessionid){if(this.INITED)return this;this.createStyle();this.create();this.bind();this.INITED=!0;return this}},createStyle:function(){var a=".{{prefixCls}}checkcode-img,.{{prefixCls}}checkcode-audio{width:175px;height:32px;line-height:32px;position:absolute;}.{{prefixCls}}checkcode-audio{display:none;}.{{prefixCls}}checkcode-img img,.{{prefixCls}}checkcode-audio audio{float:left;display:inline;width:100px;height:30px;border:1px solid #CDCDCD;cursor:pointer;}.{{prefixCls}}checkcode-refresh{display:none;width:100px;height:30px;vertical-align:middle;border:1px solid #CDCDCD;position:absolute;left:0;top:0;cursor:pointer;}.{{prefixCls}}audio-state{float:left;display:inline;width:100px;height:30px;border:1px solid #CDCDCD;position:relative;}.{{prefixCls}}audio-state-text{display:block;width:70px;height:30px;padding-left:30px;font-size:12px;color:#999;text-decoration:none;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 10px -93px;z-index:1;position:absolute;cursor:text;}.{{prefixCls}}audio-state-text:hover{text-decoration:none;}.{{prefixCls}}audio-state-progress{width:0;height:30px;background-color:#186BCA;position:absolute;left:0;top:0;z-index:0;}.{{prefixCls}}audio-over{width:100px;padding-left:0;color:#186BCA;text-align:center;background:none;cursor:pointer;}.{{prefixCls}}audio-over:hover{text-decoration:underline;}.{{prefixCls}}checkcode-refresher{float:left;display:inline;width:32px;height:32px;vertical-align:top;text-indent:-9999em;outline:none;border-right:1px solid #DDD;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 7px -145px;}.{{prefixCls}}checkcode-switcher{float:left;display:inline;width:32px;height:32px;vertical-align:top;text-indent:-9999em;outline:none;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 0 0;}.{{prefixCls}}checkcode-refresher,.{{prefixCls}}checkcode-switcher{filter:alpha(opacity=70);opacity:0.7;}.{{prefixCls}}checkcode-refresher:hover,.{{prefixCls}}checkcode-switcher:hover{filter:alpha(opacity=100);opacity:1;border-color:#EAEAEA;}.{{prefixCls}}audio-switcher{background-position:6px -40px;}.{{prefixCls}}img-switcher{background-position:5px 10px;}".replace(/{{prefixCls}}/g,
this.prefixCls),b=g.create("<style>",{type:"text/css"});b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));g.append(b,"head")},create:function(){var a=this.uid;this.container.html(b.substitute('<div class="{prefixCls}checkcode-img" id="J_ImgCode{uid}"><img id="J_CheckCodeImg{uid}" width="100" height="30" onmousedown="return false;"/><a href="#nogo" onmousedown="return false;" role="button" title="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" aria-label="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" id="J_ImgRefresher{uid}" class="{prefixCls}checkcode-refresher">\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801</a><a href="#nogo" onmousedown="return false;" role="button" title="\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801" aria-label="\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801" id="J_AudioSwitcher{uid}" class="{prefixCls}checkcode-switcher {prefixCls}audio-switcher">\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801</a></div><div class="{prefixCls}checkcode-audio" id="J_AudioCode{uid}"><span class="{prefixCls}audio-state" id="J_AudioState{uid}"><a href="#nogo" class="{prefixCls}audio-state-text" id="J_AudioStateText{uid}" onmousedown="return false;"></a><span class="{prefixCls}audio-state-progress" id="J_AudioStateProgress{uid}"></span></span><a href="#nogo" role="button" onmousedown="return false;" title="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" aria-label="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" id="J_AudioRefresher{uid}" class="{prefixCls}checkcode-refresher">\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801</a><a href="#nogo" role="button" onmousedown="return false;" title="\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801" aria-label="\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801" id="J_ImgSwitcher{uid}" class="{prefixCls}checkcode-switcher {prefixCls}img-switcher">\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801</a></div>',
{prefixCls:this.prefixCls,uid:a}));this.imgCode=b.one("#J_ImgCode"+a);this.audioCode=b.one("#J_AudioCode"+a);this.imgSwitcher=b.one("#J_ImgSwitcher"+a);this.audioSwitcher=b.one("#J_AudioSwitcher"+a);this.refresher=b.all("."+this.prefixCls+"checkcode-refresher");this.img=b.one("#J_CheckCodeImg"+a);this.audioState=b.one("#J_AudioState"+a);this.audioStateText=b.one("#J_AudioStateText"+a);this.audioProgress=b.one("#J_AudioStateProgress"+a);a={apiserver:this.apiserver,identity:this.identity,sessionid:this.sessionid};
this.getImgURL=b.substitute("{apiserver}/get_img?identity={identity}&sessionid={sessionid}&kjtype=default",a);this.checkImgURL=b.substitute("{apiserver}/check_img?identity={identity}&sessionid={sessionid}&delflag=0",a);this.getAudioURL=b.substitute("{apiserver}/get_audio?identity={identity}&sessionid={sessionid}",a);this.checkAudioURL=b.substitute("{apiserver}/check_audio?identity={identity}&sessionid={sessionid}&delflag=0",a);this.CREATED=!0},bind:function(){var a=this;this.bindImg();this.bindAudio();
this.refresher.on("click",function(b){b.halt();a.refresh();a.focus()});this.input.on("valuechange",function(a){if((!a.prevVal||0===a.prevVal.length||4===a.prevVal.length)&&1===a.newVal.length)h=b.now()}).on("paste",function(){0===this.value.length&&(h=b.now())})},bindImg:function(){if(!this.img)return this;var a=this;this.img&&this.img.on("click",function(){a.refresh();a.focus()}).on("load",function(){}).on("error",function(){a.log({e:"IMGERROR"})});this.imgSwitcher&&this.imgSwitcher.on("click",function(b){b.halt();
a.switchTo("img");a.focus()});return this},bindAudio:function(){var a=this;this.audioSwitcher.on("click",function(b){b.halt();a.switchTo("audio");a.refresh();a.focus()});this.audioStateText.on("click",function(b){b.halt();a.audioOver&&(a.refresh(),a.focus())});return this},bindAudioProgress:function(){var a=this;if(this.audioSupport)this.audio.on("timeupdate",function(){j&&(!this.duration||Infinity===this.duration)?a.progress(100):a.progress(parseInt(100*this.currentTime/this.duration))},this.audio[0]).on("play",
function(){},this.audio[0]).on("ended",function(){a.progress(100)},this.audio[0])},switchTo:function(a){if(!a||!b.isString(a))return this;a=a.toUpperCase();"IMG"===a?(this.audioCode.hide(),this.stopAudio(),this.imgCode.css({display:"block"}),this.codeType=a):"AUDIO"===a&&(this.imgCode.hide(),this.audioProgress.width(0),this.audioStateText.removeClass(this.prefixCls+"audio-replay"),this.audioCode.css({display:"block"}),this.codeType=a);this.checkedCode="";this.toggleRefresher();this.SHOWED=!0;this.fire("switch");
return this},toggleRefresher:function(){"AUDIO"!==this.codeType?this.refresher.show():(!this.audioSupport||j)&&this.refresher.hide()},refreshImg:function(){if(!this.getImgURL)return this;this.img.attr("src",this.getImgURL+(0<=this.getImgURL.indexOf("?")?"&t=":"?t=")+b.now());return this},refreshAudio:function(){if(!this.getAudioURL)return this;var a=this.getAudioURL+(0<=this.getAudioURL.indexOf("?")?"&t=":"?t=")+b.now();this.stopAudio();this.audioOver=!1;this.audioSupport?(this.audioDuration=0,this.audio=
b.one(new Audio(a)),this.audio[0].play(),this.bindAudioProgress()):(o?(a=g.create("<bgsound>",{autostart:!0,id:"J_BgSound"+this.uid,src:a}),g.append(a,"head"),this.player=b.one("#J_BgSound"+this.uid)):(b.one("body").append('<embed src="'+a+'" id="J_EmbedSound'+this.uid+'"'+(n?'type="application/x-mplayer2"':'type="audio/x-wav"')+" autostart hidden />"),this.player=b.one("#J_EmbedSound"+this.uid)),this.progress("NOPROGRESS"));return this},refresh:function(a){a=b.isString(a)&&a?a.toUpperCase():this.codeType;
"IMG"===a?this.refreshImg():"AUDIO"===a&&this.refreshAudio();this.checkedCode="";this.fire("refresh");k=h=b.now()},focus:function(){this.input[0].focus();this.input[0].select()},stopAudio:function(){this.audioSupport?this.audio&&this.audio[0]&&this.audio[0].pause():this.player&&(this.player[0].src="",this.player.remove(),this.player=null)},replayAudio:function(){this.audioSupport&&this.audio&&(this.audio[0].currentTime=0,this.audio[0].pause(),this.audio[0].play())},showImg:function(){this.switchTo("img");
this.refresh();return this},showAudio:function(){this.switchTo("audio");return this},audioSupport:function(){try{return"Audio"in window&&(new Audio).canPlayType("audio/x-wav")}catch(a){return!1}}(),progress:function(a){switch(a){case -1:this.audioStateText.text("\u6b63\u5728\u52a0\u8f7d");break;case 100:case "NOPROGRESS":this.audioOver=!0;this.audioProgress.css({width:"0"});this.audioStateText.addClass(this.prefixCls+"audio-over").text("\u70b9\u51fb\u64ad\u653e\u8bed\u97f3");break;default:this.audioStateText.removeClass(this.prefixCls+"audio-over").text("\u8bf7\u4ed4\u7ec6\u6536\u542c"),
this.audioProgress.css({width:a+"%"})}},check:function(a){var d=b.trim(this.input.val()),a=b.isFunction(a)?a:function(){};if(m.test(d))if(this.checkedCode&&this.checkedCode===d)a({success:!0,codeType:this.codeType});else{f[d]=a;if(this.checkingCode){if(this.checkingCode===d)return;this.io&&this.io.abort&&this.io.abort()}this.checkingCode=d;b.later(function(){this._check(a)},500,!1,this)}else a({success:!1,codeType:this.codeType})},_check:function(){function a(){"IMG"===c.codeType?c.refresh():(c.progress(100),
c.stopAudio());c.checkedCode="";f[e]&&f[e]({success:!1,codeType:c.codeType})}var d="IMG"==this.codeType?this.checkImgURL:this.checkAudioURL,e=b.trim(this.input.val()),c=this;c.io=b.io({url:d,data:{code:e},dataType:"jsonp",success:function(d){c.checkingCode="";c.log({t1:b.now()-h,t2:b.now()-k,s:d&&"SUCCESS."===d.message,t:c.codeType});d&&"SUCCESS."===d.message?(c.progress(100),c.stopAudio(),c.checkedCode=e,f[e]&&f[e]({success:!0,codeType:c.codeType})):a()},error:function(){a()}})},log:function(a){a&&
((new Image).src="http://acjs.aliyun.com/captchaerror?"+b.param(a))}});return b.checkcode=i});
